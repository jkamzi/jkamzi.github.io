<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>My Blog</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>

<body>
  <div class="container mx-auto p-4">
    <div class="prose max-w-none">
      <h1>This is my Title</h1>
<p>This is a paragraph of text.</p>
<p>Node env: development</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token comment"># test/app_web/controllers/user_confirmation_controller_test.exs</span><br><span class="token keyword">defmodule</span> AppWeb<span class="token punctuation">.</span>UserConfirmationControllerTest <span class="token keyword">do</span><br>  <span class="token keyword">use</span> AppWeb<span class="token punctuation">.</span>ConnCase<span class="token punctuation">,</span> <span class="token attr-name">async:</span> <span class="token boolean">true</span><br><br>  <span class="token keyword">alias</span> App<span class="token punctuation">.</span>Accounts<br>  <span class="token keyword">alias</span> App<span class="token punctuation">.</span>Repo<br>  <span class="token keyword">import</span> App<span class="token punctuation">.</span>AccountsFixtures<br><br>  setup <span class="token keyword">do</span><br>    <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">user:</span> user_fixture<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>  <span class="token keyword">end</span><br><br>  describe <span class="token string">"GET /users/confirm"</span> <span class="token keyword">do</span><br>    test <span class="token string">"renders the confirmation page"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">conn:</span> conn<span class="token punctuation">}</span> <span class="token keyword">do</span><br>      conn <span class="token operator">=</span> get<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      response <span class="token operator">=</span> html_response<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><br>      assert response <span class="token operator">=~</span> <span class="token string">"&lt;h1>Resend confirmation instructions&lt;/h1>"</span><br>    <span class="token keyword">end</span><br>  <span class="token keyword">end</span><br><br>  describe <span class="token string">"POST /users/confirm"</span> <span class="token keyword">do</span><br>    <span class="token attribute variable">@tag</span> <span class="token atom symbol">:capture_log</span><br>    test <span class="token string">"sends a new confirmation token"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">conn:</span> conn<span class="token punctuation">,</span> <span class="token attr-name">user:</span> user<span class="token punctuation">}</span> <span class="token keyword">do</span><br>      conn <span class="token operator">=</span><br>        post<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:create</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><br>          <span class="token string">"user"</span> <span class="token operator">=></span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"email"</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>email<span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      assert get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:info</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"If your email is in our system"</span><br>      assert Repo<span class="token punctuation">.</span>get_by!<span class="token punctuation">(</span>Accounts<span class="token punctuation">.</span>UserToken<span class="token punctuation">,</span> <span class="token attr-name">user_id:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>context <span class="token operator">==</span> <span class="token string">"confirm"</span><br>    <span class="token keyword">end</span><br><br>    test <span class="token string">"does not send confirmation token if User is confirmed"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">conn:</span> conn<span class="token punctuation">,</span> <span class="token attr-name">user:</span> user<span class="token punctuation">}</span> <span class="token keyword">do</span><br>      Repo<span class="token punctuation">.</span>update!<span class="token punctuation">(</span>Accounts<span class="token punctuation">.</span>User<span class="token punctuation">.</span>confirm_changeset<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      conn <span class="token operator">=</span><br>        post<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:create</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><br>          <span class="token string">"user"</span> <span class="token operator">=></span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"email"</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>email<span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      assert get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:info</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"If your email is in our system"</span><br>      refute Repo<span class="token punctuation">.</span>get_by<span class="token punctuation">(</span>Accounts<span class="token punctuation">.</span>UserToken<span class="token punctuation">,</span> <span class="token attr-name">user_id:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><br>    <span class="token keyword">end</span><br><br>    test <span class="token string">"does not send confirmation token if email is invalid"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">conn:</span> conn<span class="token punctuation">}</span> <span class="token keyword">do</span><br>      conn <span class="token operator">=</span><br>        post<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:create</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><br>          <span class="token string">"user"</span> <span class="token operator">=></span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token string">"email"</span> <span class="token operator">=></span> <span class="token string">"unknown@example.com"</span><span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      assert get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:info</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"If your email is in our system"</span><br>      assert Repo<span class="token punctuation">.</span>all<span class="token punctuation">(</span>Accounts<span class="token punctuation">.</span>UserToken<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>    <span class="token keyword">end</span><br>  <span class="token keyword">end</span><br><br>  describe <span class="token string">"GET /users/confirm/:token"</span> <span class="token keyword">do</span><br>    test <span class="token string">"confirms the given token once"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">conn:</span> conn<span class="token punctuation">,</span> <span class="token attr-name">user:</span> user<span class="token punctuation">}</span> <span class="token keyword">do</span><br>      token <span class="token operator">=</span><br>        extract_user_token<span class="token punctuation">(</span><span class="token keyword">fn</span> url <span class="token operator">-></span><br>          Accounts<span class="token punctuation">.</span>deliver_user_confirmation_instructions<span class="token punctuation">(</span>user<span class="token punctuation">,</span> url<span class="token punctuation">)</span><br>        <span class="token keyword">end</span><span class="token punctuation">)</span><br><br>      conn <span class="token operator">=</span> get<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:confirm</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      assert get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:info</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"User confirmed successfully"</span><br>      assert Accounts<span class="token punctuation">.</span>get_user!<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>confirmed_at<br>      refute get_session<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:user_token</span><span class="token punctuation">)</span><br>      assert Repo<span class="token punctuation">.</span>all<span class="token punctuation">(</span>Accounts<span class="token punctuation">.</span>UserToken<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>      <span class="token comment"># When not logged in</span><br>      conn <span class="token operator">=</span> get<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:confirm</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      assert get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:error</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"User confirmation link is invalid or it has expired"</span><br><br>      <span class="token comment"># When logged in</span><br>      conn <span class="token operator">=</span><br>        build_conn<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token operator">|></span> log_in_user<span class="token punctuation">(</span>user<span class="token punctuation">)</span><br>        <span class="token operator">|></span> get<span class="token punctuation">(</span>Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:confirm</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      refute get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:error</span><span class="token punctuation">)</span><br>    <span class="token keyword">end</span><br><br>    test <span class="token string">"does not confirm email with invalid token"</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">conn:</span> conn<span class="token punctuation">,</span> <span class="token attr-name">user:</span> user<span class="token punctuation">}</span> <span class="token keyword">do</span><br>      conn <span class="token operator">=</span> get<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> Routes<span class="token punctuation">.</span>user_confirmation_path<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:confirm</span><span class="token punctuation">,</span> <span class="token string">"oops"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      assert redirected_to<span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><br>      assert get_flash<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token atom symbol">:error</span><span class="token punctuation">)</span> <span class="token operator">=~</span> <span class="token string">"User confirmation link is invalid or it has expired"</span><br>      refute Accounts<span class="token punctuation">.</span>get_user!<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>confirmed_at<br>    <span class="token keyword">end</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span></code></pre>

    </div>
  </div>
</body>

</html>
